/*

visit the page cookies:
	
datr
WJHNUz2QoVYiDgothpMo6pnL

reg_fb_gate
https%3A%2F%2Fwww.facebook.com%2F

reg_fb_ref
https%3A%2F%2Fwww.facebook.com%2F

wd
1271x691

<form id="login_form" action="https://www.facebook.com/login.php?login_attempt=1" method="post" onsubmit="return window.Event &amp;&amp; Event.__inlineSubmit &amp;&amp; Event.__inlineSubmit(this,event)">
<input type="hidden" name="lsd" value="AVoly42_" autocomplete="off" />
    <table cellspacing="0">
    <tr>
    <td class="html7magic"><label for="email">Email or Phone</label></td>
    <td class="html7magic"><label for="pass">Password</label></td>
    </tr>
    <tr>
    <td><input type="text" class="inputtext" name="email" id="email" value="" tabindex="1" /></td>
    <td><input type="password" class="inputtext" name="pass" id="pass" tabindex="2" /></td>
    <td><label class="uiButton uiButtonConfirm" id="loginbutton" for="u_0_l"><input value="Log in" tabindex="4" type="submit" id="u_0_l" /></label></td>
    </tr>
    <tr>
    <td class="login_form_label_field"><div><div class="uiInputLabel clearfix uiInputLabelLegacy"><input id="persist_box" type="checkbox" name="persistent" value="1" tabindex="3" class="uiInputLabelInput uiInputLabelCheckbox" /><label for="persist_box" class="uiInputLabelLabel">Keep me logged in</label></div><input type="hidden" name="default_persistent" value="0" /></div></td>
    <td class="login_form_label_field"><a rel="nofollow" href="https://www.facebook.com/recover/initiate">Forgotten your password?</a></td>
    </tr>
    </table>
    <input type="hidden" autocomplete="off" name="timezone" value="" id="u_0_m" />
    <input type="hidden" name="lgnrnd" value="151918_D7GO" />
    <input type="hidden" id="lgnjs" name="lgnjs" value="n" />
    <input type="hidden" autocomplete="off" id="locale" name="locale" value="en_GB" />
</form>

<form id="login_form" action="https://www.facebook.com/login.php?login_attempt=1" method="post" onsubmit="return window.Event &amp;&amp; Event.__inlineSubmit &amp;&amp; Event.__inlineSubmit(this,event)"><input type="hidden" name="lsd" value="AVoly42_" autocomplete="off">
<table cellspacing="0"><tbody><tr><td class="html7magic"><label for="email">Email or Phone</label></td><td class="html7magic"><label for="pass">Password</label></td></tr><tr><td><input type="text" class="inputtext" name="email" id="email" value="" tabindex="1"></td><td><input type="password" class="inputtext" name="pass" id="pass" tabindex="2"></td><td><label class="uiButton uiButtonConfirm" id="loginbutton" for="u_0_l"><input value="Log in" tabindex="4" type="submit" id="u_0_l"></label></td></tr><tr><td class="login_form_label_field"><div><div class="uiInputLabel clearfix uiInputLabelLegacy"><input id="persist_box" type="checkbox" name="persistent" value="1" tabindex="3" class="uiInputLabelInput uiInputLabelCheckbox"><label for="persist_box" class="uiInputLabelLabel">Keep me logged in</label></div><input type="hidden" name="default_persistent" value="0"></div></td><td class="login_form_label_field"><a rel="nofollow" href="https://www.facebook.com/recover/reason">Can't log in?</a></td></tr></tbody></table><input type="hidden" autocomplete="off" name="timezone" value="240" id="u_0_m"><input type="hidden" name="lgnrnd" value="151656_6H5x"><input type="hidden" id="lgnjs" name="lgnjs" value="1405981012"><input type="hidden" autocomplete="off" id="locale" name="locale" value="en_GB"></form>


lsd:AVoly42_ // regex
email:chizuomeretsu@gmail.com // easy
pass:p@ssw0rd // easy 
default_persistent:0 // easy
timezone:240 // static 240
lgnrnd:151656_6H5x // easy????
lgnjs:1405981012 // hard....
locale:en_GB

*/

/* change password requests:
{
password.php
/ajax/settings/account
POST
200
OK
application/x-javascript
75czBK7uQBv.js:15
Script
2.8 KB
2.4 KB
1.06 s
1.06 s
jp4VO8dH1iO.js
fbstatic-a.akamaihd.net/rsrc.php/v2/yV/r
GET
200
OK
application/x-javascript
VHFE657H7nB.js:86
Script
716 B
870 B
10 ms
10 ms
dialog?ijt=1405985590
/ajax/login/password/change_reason
POST
200
OK
application/x-javascript
75czBK7uQBv.js:15
Script
2.9 KB
4.4 KB
61 ms
60 ms
pull?channel=p_100005107247704&seq=1&partition=-2&clientid=78e32d6d&cb=6q2x&idle=0&cap=0&sticky_token=209&traceid=GXpQ9&state=active
6-channel-proxy-13-prn1.facebook.com
GET
200
OK
application/json
75czBK7uQBv.js:15
Script
500 B
76 B
81 ms
81 ms
pull?channel=p_100005107247704&seq=2&partition=-2&clientid=78e32d6d&cb=4fs9&idle=0&cap=0&sticky_token=209&traceid=GXpQ9&state=active
6-channel-proxy-13-prn1.facebook.com
GET
(pending)
75czBK7uQBv.js:15
Script
0 B
0 B
Pending
dialog?ijt=1405985590
/ajax/login/password/change_reason
POST
200
OK
application/x-javascript
75czBK7uQBv.js:15
Script
2.6 KB
2.6 KB
236 ms
232 ms
}




fb_dtsg:AQHOW3frAtWF
password_strength:3
password_old:p@ssw0rd
password_new:p@ssw0rd2
password_confirm:p@ssw0rd2
__user:100005107247704
__a:1
__dyn:7n8ajEAMNoSdDgDxyF4Eio99Esx6bF299qBykC-C26m6oKp6Dzogxd0
__req:d
ttstamp:2658172798751102114651168770
__rev:1335099


*/

/*


fb_dtsg:AQHOW3frAtWF
password_strength:3
password_old:p@ssw0rd
password_new:p@ssw0rd2
password_confirm:p@ssw0rd2
__user:100005107247704
__a:1
__dyn:7n8ajEAMNoSdDgDxyF4Eio99Esx6bF299qBykC-C26m6oKp6Dzogxd0
__req:d
ttstamp:2658172798751102114651168770
__rev:1335099


fb_dtsg:AQFGdR3fjhVw
password_strength:3
password_old:p@ssw0rd2
password_new:p@ssw0rd
password_confirm:p@ssw0rd
__user:100005107247704
__a:1
__dyn:7n8ahyj35zoSt2u6aAix9wACxO4oKAdBGfirWo8popyUW5ogxd0
__req:7
ttstamp:265817071100825110210610486119
__rev:1335099

*/

// easier than i thought
// TEST DATA =
//  email: chizuomeretsu@gmail.com
//  pass: p@ssw0rd

var status = -1;
var fail = false;
var canLogin = true;
var temp = "";

var email = "";
var password = "";

var test = "";

function body(state, mode, value) {

    switch (state) {

        case 0:
            email = AccessHandler.Access("email");
            password = AccessHandler.Access("password");
            log("email=" + email);
            log("password=" + password);
            ViewHandler.ShowTextDialog("This script will change your facebook account password.\n\nIs this ok?");
            break;

        case 1:
            if (email == "" || password == "") {
                fail = true;
                ViewHandler.ShowTextDialog("The \"email\" and \"password\" fields must be set.");
            }
            else {
                fail = false;
                login(email, password);
                test = checklogin();
                if (test != undefined && test != "") {
                    ViewHandler.ShowInputDialog("New password:");
                }
                else {
                    canLogin = false;
                    ViewHandler.ShowTextDialog("Unable to login with current information.");
                }
            }
            break;

        case 2:
            if (canLogin == false || fail == true) {
                ViewHandler.Close();
            }
            else {
                newPassword = value;
                changepassword(password, newPassword);
                login(email, newPassword);
                test = checklogin();
                if (test != undefined && test != "") {
                    ViewHandler.ShowTextDialog("Your password has been changed!");
                    AccessHandler.Set("password", newPassword);
                }
                else {
                    ViewHandler.ShowTextDialog("Unable to change password.");
                }
            }
            break;

        default:
            ViewHandler.Close();
            break;

    }

}

function changepassword(oldpassword, newpassword) {

    var psswdhtml = WebHandler.SendGet("https://www.facebook.com/settings");

    var userid = get_userid(psswdhtml);
    var rev = get_rev(psswdhtml);
    var dtsg = get_dtsg(psswdhtml);

    var ret = WebHandler.SendPost(
        "https://www.facebook.com/ajax/settings/account/password.php",
        "password_old=" + oldpassword +
        "&password_new=" + newpassword + 
        "&password_confirm=" + newpassword +
        "&password_strength=3" + 
        "&__a=1" +
        "&__user=" + userid +
        "&__rev=" + rev +
        "&fb_dtsg=" + dtsg
    );

}

function login(email, password) {

    WebHandler.ClearCookies();
    WebHandler.SendGet("https://www.facebook.com/");

    var ret = WebHandler.SendPost(
        "https://www.facebook.com/login.php?login_attempt=1",
        "email=" + email + 
        "&pass=" + password
    );

}

function checklogin() {

    /*  temp test */
    var psswdhtml = WebHandler.SendGet("https://www.facebook.com/settings");

    var userid = get_userid(psswdhtml);
    var rev = get_rev(psswdhtml);
    var dtsg = get_dtsg(psswdhtml);

    if (userid != "" && rev != "" && dtsg != "") return userid;

    return "";

    /* old version */

    var html = WebHandler.SendGet("https://www.facebook.com/?sk=welcome");
    var regex = /headerTinymanName">([^\<]+)</ig;
    var result = regex.exec(html);

    if (result != undefined && result.length >= 2) {
        return result[1];
    }

    return "";

}

function get_dtsg(html) {

    var regex = /name\=\"fb_dtsg\"\ value\=\"([^\"]+)\"/ig;
    var result = regex.exec(html);

    if (result != undefined && result.length >= 2) {
        return result[1];
    }

    return "";

}

function get_rev(html) {

    var regex = /\"revision\"\:([^\,]+),/ig;
    var result = regex.exec(html);

    if (result != undefined && result.length >= 2) {
        return result[1];
    }

    return "";

}

function get_userid(html) {

    var regex = /id\=\"profile\_pic\_header\_([^\"]+)\"/ig;
    var result = regex.exec(html);

    if (result != undefined && result.length >= 2) {
        return result[1];
    }

    return "";

}
